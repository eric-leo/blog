---
title: JSè¿›é˜¶ä¹‹EventLoop
date: 2019-01-14 15:33:54
type: "js-base"
tag: js
description:
keywords:
top_img:
mathjax:
katex:
aside:
---
### å¼•è¨€

å¼€å§‹ä»‹ç»EventLoopä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸€äº›å‰ç½®åŸºç¡€çŸ¥è¯†â€”â€”çº¿ç¨‹å’Œè¿›ç¨‹ã€‚

### è¿›ç¨‹å’Œçº¿ç¨‹

#### è¿›ç¨‹

- CPUæ‰¿æ‹…äº†æ‰€æœ‰çš„è®¡ç®—ä»»åŠ¡
- è¿›ç¨‹æ˜¯CPUèµ„æºåˆ†é…çš„æœ€å°å•ä½
- åœ¨åŒä¸€ä¸ªæ—¶é—´å†…ï¼Œå•ä¸ªCPUåªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œåªèƒ½è¿è¡Œä¸€ä¸ªè¿›ç¨‹
- å¦‚æžœæœ‰ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå…¶å®ƒè¿›ç¨‹å°±å¾—æš‚åœ
- CPUä½¿ç”¨äº†æ—¶é—´ç‰‡è½®è½¬çš„ç®—æ³•å®žçŽ°å¤šè¿›ç¨‹çš„è°ƒåº¦

#### çº¿ç¨‹

- çº¿ç¨‹æ˜¯ CPUè°ƒåº¦çš„æœ€å°å•ä½
- ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…æ‹¬å¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å…±äº«è¿™ä¸ªè¿›ç¨‹çš„èµ„æº

### chromeæµè§ˆå™¨è¿›ç¨‹

- æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹çš„
- æ¯ä¸€ä¸ªTABé¡µå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹
- æµè§ˆå™¨ä¸»è¿›ç¨‹
    - æŽ§åˆ¶å…¶å®ƒå­è¿›ç¨‹çš„åˆ›å»ºå’Œé”€æ¯
    - æµè§ˆå™¨ç•Œé¢æ˜¾ç¤ºï¼Œæ¯”å¦‚ç”¨æˆ·äº¤äº’ã€å‰è¿›ã€åŽé€€ç­‰æ“ä½œ
    - å°†æ¸²æŸ“çš„å†…å®¹ç»˜åˆ¶åˆ°ç”¨æˆ·ç•Œé¢ä¸Š
- æ¸²æŸ“è¿›ç¨‹å°±æ˜¯æˆ‘ä»¬è¯´çš„æµè§ˆå™¨å†…æ ¸
    - è´Ÿè´£é¡µé¢çš„æ¸²æŸ“ã€è„šæœ¬æ‰§è¡Œã€äº‹ä»¶å¤„ç†
    - æ¯ä¸ªTABé¡µéƒ½æœ‰ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹
- ç½‘ç»œè¿›ç¨‹ å¤„ç†ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è®¿é—®ç­‰æ“ä½œ
- GPUè¿›ç¨‹ ç”¨äºŽ3Dç»˜åˆ¶
- ç¬¬ä¸‰æ–¹æ’ä»¶è¿›ç¨‹

### æ¸²æŸ“è¿›ç¨‹

- GUIæ¸²æŸ“çº¿ç¨‹
    - æ¸²æŸ“ã€å¸ƒå±€å’Œç»˜åˆ¶é¡µé¢
    - å½“é¡µé¢éœ€è¦é‡ç»˜å’Œå›žæµæ—¶ï¼Œæ­¤çº¿ç¨‹å°±ä¼šæ‰§è¡Œ
    - ä¸ŽJSå¼•æ“Žäº’æ–¥

- JSå¼•æ“Žçº¿ç¨‹
    - è´Ÿè´£è§£æžæ‰§è¡ŒJSè„šæœ¬
    - åªæœ‰ä¸€ä¸ªJSå¼•æ“Žçº¿ç¨‹(å•çº¿ç¨‹)
    - ä¸ŽGUIæ¸²æŸ“çº¿ç¨‹äº’æ–¥

- äº‹ä»¶è§¦å‘çº¿ç¨‹
    - ç”¨æ¥æŽ§åˆ¶äº‹ä»¶å¾ªçŽ¯(é¼ æ ‡ç‚¹å‡»ã€setTimeoutã€Ajaxç­‰)
    - å½“äº‹ä»¶æ»¡è¶³è§¦å‘æ¡ä»¶æ—¶ï¼ŒæŠŠäº‹ä»¶æ”¾å…¥åˆ°JSå¼•æ“Žæ‰€æœ‰çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­

- å®šæ—¶å™¨è§¦å‘çº¿ç¨‹
    - setIntervalå’ŒsetTimeoutæ‰€åœ¨çº¿ç¨‹
    - å®šæ—¶ä»»åŠ¡å¹¶ä¸æ˜¯ç”±JSå¼•æ“Žè®¡æ—¶ï¼Œè€Œæ˜¯ç”±å®šæ—¶è§¦å‘çº¿ç¨‹æ¥è®¡æ—¶çš„
    - è®¡æ—¶å®Œæ¯•åŽä¼šé€šçŸ¥äº‹ä»¶è§¦å‘çº¿ç¨‹

- å¼‚æ­¥HTTPè¯·æ±‚çº¿ç¨‹
    - æµè§ˆå™¨æœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å¤„ç†AJAXè¯·æ±‚
    - å½“è¯·æ±‚å®Œæ¯•åŽï¼Œå¦‚æžœæœ‰å›žè°ƒå‡½æ•°ï¼Œä¼šé€šçŸ¥äº‹ä»¶è§¦å‘çº¿ç¨‹

### EventLoop

åœ¨äº†è§£ Event Loop ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç†Ÿæ‚‰ä¸€ä¸‹æ‰§è¡Œæ ˆå’Œäº‹ä»¶é˜Ÿåˆ—è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚

#### æ‰§è¡Œæ ˆ

å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œjsä¼šç”Ÿæˆä¸€ä¸ªä¸Žè¿™ä¸ªæ–¹æ³•ç›¸å¯¹åº”çš„æ‰§è¡ŒçŽ¯å¢ƒï¼Œä¹Ÿå«æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ‰§è¡ŒçŽ¯å¢ƒå­˜åœ¨ç€è¿™ä¸ªæ–¹æ³•çš„ç§æœ‰ä½œç”¨åŸŸã€å‚æ•°ã€thiså¯¹è±¡ç­‰ç­‰ã€‚å› ä¸ºjsæ˜¯å•çº¿ç¨‹çš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥å½“ä¸€ç³»åˆ—çš„æ–¹æ³•è¢«ä¾æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œjsä¼šå…ˆè§£æžè¿™äº›æ–¹æ³•ï¼ŒæŠŠå…¶ä¸­çš„åŒæ­¥ä»»åŠ¡æŒ‰ç…§æ‰§è¡Œé¡ºåºæŽ’é˜Ÿåˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹å«åšæ‰§è¡Œæ ˆã€‚

#### äº‹ä»¶é˜Ÿåˆ—

å½“æˆ‘ä»¬å‘å‡ºä¸€ä¸ªajaxè¯·æ±‚ï¼Œä»–å¹¶ä¸ä¼šç«‹åˆ»è¿”å›žç»“æžœï¼Œä¸ºäº†é˜²æ­¢æµè§ˆå™¨å‡ºçŽ°å‡æ­»æˆ–è€…ç©ºç™½ï¼Œä¸»çº¿ç¨‹ä¼šæŠŠè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‚èµ·(pending)ï¼Œç»§ç»­æ‰§è¡Œæ‰§è¡Œæ ˆä¸­çš„å…¶ä»–ä»»åŠ¡ï¼Œç­‰å¼‚æ­¥ä»»åŠ¡è¿”å›žç»“æžœåŽï¼Œjsä¼šå°†è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‰ç…§æ‰§è¡Œé¡ºåºï¼ŒåŠ å…¥åˆ°ä¸Žæ‰§è¡Œæ ˆä¸åŒçš„å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é˜Ÿåˆ—ã€‚


![img1.jpg](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcvu9kvj4j30gp0endg6.jpg)


å¦‚å›¾æ‰€ç¤ºï¼š

- ä¸»çº¿ç¨‹è¿è¡Œçš„æ—¶å€™ä¼šç”Ÿæˆå †ï¼ˆheapï¼‰å’Œæ ˆï¼ˆstack
- jsä»Žä¸Šåˆ°ä¸‹è§£æžæ–¹æ³•ï¼Œå°†å…¶ä¸­çš„åŒæ­¥ä»»åŠ¡æŒ‰ç…§æ‰§è¡Œé¡ºåºæŽ’åˆ—åˆ°æ‰§è¡Œæ ˆä¸­
- å½“ç¨‹åºè°ƒç”¨å¤–éƒ¨çš„APIæ—¶ï¼Œæ¯”å¦‚ajaxã€setTimeoutç­‰ï¼Œä¼šå°†æ­¤ç±»å¼‚æ­¥ä»»åŠ¡æŒ‚èµ·ï¼Œç»§ç»­æ‰§è¡Œæ‰§è¡Œæ ˆä¸­çš„ä»»åŠ¡ï¼Œç­‰å¼‚æ­¥ä»»åŠ¡è¿”å›žç»“æžœåŽï¼Œå†æŒ‰ç…§æ‰§è¡Œé¡ºåºæŽ’åˆ—åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­
- ä¸»çº¿ç¨‹å…ˆå°†æ‰§è¡Œæ ˆä¸­çš„åŒæ­¥ä»»åŠ¡æ¸…ç©ºï¼Œç„¶åŽæ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æžœæœ‰ï¼Œå°±å°†ç¬¬ä¸€ä¸ªäº‹ä»¶å¯¹åº”çš„å›žè°ƒæŽ¨åˆ°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œï¼Œè‹¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚æ­¥ä»»åŠ¡ï¼Œåˆ™ç»§ç»­å°†è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æŽ’åˆ—åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­
- ä¸»çº¿ç¨‹æ¯æ¬¡å°†æ‰§è¡Œæ ˆæ¸…ç©ºåŽï¼Œå°±åŽ»äº‹ä»¶é˜Ÿåˆ—ä¸­æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æžœæœ‰ï¼Œå°±æ¯æ¬¡å–å‡ºä¸€ä¸ªæŽ¨åˆ°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ªçŽ¯å¾€å¤çš„... è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºâ€œEvent Loop äº‹ä»¶å¾ªçŽ¯â€ã€‚

ä»¥ä¸Šçš„äº‹ä»¶å¾ªçŽ¯è¿‡ç¨‹åªæ˜¯ä¸€ä¸ªå®è§‚çš„è¡¨è¿°ï¼Œå®žé™…ä¸Šå¼‚æ­¥ä»»åŠ¡ä¹‹é—´ä¹Ÿä¸ç›¸åŒï¼Œæ‰§è¡Œä¼˜å…ˆçº§ä¹Ÿæœ‰åŒºåˆ«ã€‚ä¸åŒçš„å¼‚æ­¥ä»»åŠ¡è¢«åˆ†ä¸ºä¸¤ç±»ï¼šå®ä»»åŠ¡ï¼ˆmacro taskï¼‰å’Œå¾®ä»»åŠ¡ï¼ˆmicro taskï¼‰ã€‚æˆ‘ä»¬å°†ç»å¸¸é‡åˆ°çš„å¼‚æ­¥ä»»åŠ¡è¿›è¡Œåˆ†ç±»å¦‚ä¸‹ï¼š

**å®ä»»åŠ¡**ï¼šsetTimeoutï¼ŒsetIntervalï¼ŒsetImmediateï¼ŒI/O(ç£ç›˜è¯»å†™æˆ–ç½‘ç»œé€šä¿¡)ï¼ŒUIäº¤äº’äº‹ä»¶

**å¾®ä»»åŠ¡**ï¼šprocess.nextTickï¼ŒPromise.then

![img.jpg](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcvueisauj30g909x3yy.jpg)

å‰é¢æˆ‘ä»¬ä»‹ç»ï¼Œäº‹ä»¶å¾ªçŽ¯ä¼šå°†å…¶ä¸­çš„å¼‚æ­¥ä»»åŠ¡æŒ‰ç…§æ‰§è¡Œé¡ºåºæŽ’åˆ—åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚ç„¶è€Œï¼Œæ ¹æ®å¼‚æ­¥äº‹ä»¶çš„ä¸åŒåˆ†ç±»ï¼Œè¿™ä¸ªäº‹ä»¶å®žé™…ä¸Šä¼šè¢«æŽ’åˆ—åˆ°å¯¹åº”çš„å®ä»»åŠ¡é˜Ÿåˆ—æˆ–è€…å¾®ä»»åŠ¡é˜Ÿåˆ—å½“ä¸­åŽ»ã€‚

å½“æ‰§è¡Œæ ˆä¸­çš„ä»»åŠ¡æ¸…ç©ºï¼Œä¸»çº¿ç¨‹ä¼šå…ˆæ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æžœæœ‰ï¼Œå°±å°†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œä¹‹åŽå†æ£€æŸ¥å®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æžœæœ‰ï¼Œåˆ™æ¯æ¬¡å–å‡ºç¬¬ä¸€ä¸ªå®ä»»åŠ¡åŠ å…¥åˆ°æ‰§è¡Œæ ˆä¸­ï¼Œä¹‹åŽå†æ¸…ç©ºæ‰§è¡Œæ ˆï¼Œæ£€æŸ¥å¾®ä»»åŠ¡ï¼Œä»¥æ­¤å¾ªçŽ¯...

#### EventLoopç»ƒä¹ é¢˜


ä¸ºäº†åŠ æ·±å°è±¡ï¼Œæˆ‘ä»¬æ¥å‡ ä¸ªä¾‹å­ðŸŒ°ï¼š


1.
```javascript
console.log('script start');

setTimeout(function() {
  console.log('setTimeout');
}, 0);

Promise.resolve().then(function() {
  console.log('promise1');
}).then(function() {
  console.log('promise2');
});

console.log('script end');

```

è¾“å‡ºï¼š
script start
script end
promise1
promise2
setTimeout

2.
```javascript
async function async1() {
    console.log('async1 start')
    await async2()
    console.log('async1 end')
}
async function async2() {
    console.log('async2')
}
console.log('script start')
setTimeout(function () {
    console.log('setTimeout')
})
async1()
new Promise(function (resolve) {
    console.log('promise1')
    resolve()
}).then(function () {
    console.log('promise2')
})
console.log('script end')
```

è¾“å‡ºï¼š
script start
async1 start
async2
promise1
script end
async1 end
promise2
setTimeout

### Nodeä¸­çš„EventLoop

- Node.jsé‡‡ç”¨V8ä½œä¸ºjsçš„è§£æžå¼•æ“Žï¼Œè€ŒI/Oå¤„ç†æ–¹é¢ä½¿ç”¨äº†è‡ªå·±è®¾è®¡çš„libuv
- libuvæ˜¯ä¸€ä¸ªåŸºäºŽäº‹ä»¶é©±åŠ¨çš„è·¨å¹³å°æŠ½è±¡å±‚ï¼Œå°è£…äº†ä¸åŒæ“ä½œç³»ç»Ÿä¸€äº›åº•å±‚ç‰¹æ€§ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„API
- äº‹ä»¶å¾ªçŽ¯æœºåˆ¶ä¹Ÿæ˜¯å®ƒé‡Œé¢çš„å®žçŽ°
    - V8å¼•æ“Žè§£æžJavaScriptè„šæœ¬å¹¶è°ƒç”¨Node API
    - libuvåº“è´Ÿè´£Node APIçš„æ‰§è¡Œã€‚å®ƒå°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹,å½¢æˆä¸€ä¸ªEvent Loopï¼ˆäº‹ä»¶å¾ªçŽ¯ï¼‰ï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æžœè¿”å›žç»™V8å¼•æ“Ž
    - V8å¼•æ“Žå†å°†ç»“æžœè¿”å›žç»™ç”¨æˆ·

#### libuv

- åŒæ­¥æ‰§è¡Œå…¨å±€çš„è„šæœ¬
- æ‰§è¡Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ï¼Œå…ˆæ‰§è¡ŒnextTickä¸­çš„æ‰€æœ‰çš„ä»»åŠ¡ï¼Œå†æ‰§è¡Œå…¶å®ƒå¾®ä»»åŠ¡
- å¼€å§‹æ‰§è¡Œå®ä»»åŠ¡ï¼Œå…±æœ‰6ä¸ªé˜¶æ®µï¼Œä»Žç¬¬1ä¸ªé˜¶æ®µå¼€å§‹ï¼Œä¼šæ‰§è¡Œæ¯ä¸€ä¸ªé˜¶æ®µæ‰€æœ‰çš„å®ä»»åŠ¡


![img2.jpg](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcwgztukpj30tf0d9dgy.jpg)

![img3.jpg](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfcwgvnpt9j30xo0lxmzn.jpg)

#### setImmediate

setTimeout/setIntervalå–å€¼èŒƒå›´æ˜¯[1,2çš„32æ¬¡æ–¹-1],è¶…å‡ºèŒƒå›´åˆå§‹åŒ–ä¸º1ï¼Œæ‰€ä»¥ setTimeout(fn,0) = setTimeout(fn,1)

```javascript
setTimeout(function  () {
  console.log('timeout');
},0);
setImmediate(function  () {
  console.log('immediate');
});
```

```javascript
const fs = require('fs')
fs.readFile(__filename, () => {
    setTimeout(() => {
        console.log('timeout');
    }, 0)
    setImmediate(() => {
        console.log('immediate')
    })
})
```
#### process.nextTick 

nextTickç‹¬ç«‹äºŽEvent Loop,æœ‰è‡ªå·±çš„é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜¶æ®µå®ŒæˆåŽå¦‚æžœå­˜åœ¨nextTické˜Ÿåˆ—ä¼šå…¨éƒ¨æ¸…ç©ºï¼Œä¼˜å…ˆçº§é«˜äºŽå¾®ä»»åŠ¡

```javascript
setTimeout(() => {
    console.log('setTimeout1')
    Promise.resolve().then(function () {
        console.log('promise1')
    })
}, 0)
setTimeout(() => {
    console.log('setTimeout2')
    Promise.resolve().then(function () {
        console.log('promise2')
    })
}, 0)
setImmediate(() => {
    console.log('setImmediate1')
    Promise.resolve().then(function () {
        console.log('promise3')
    })
}, 0)

process.nextTick(() => {
    console.log('nextTick1');
    Promise.resolve().then(() => console.log('promise4'));
    process.nextTick(() => {
        console.log('nextTick2');
        Promise.resolve().then(() => console.log('promise5'));
        process.nextTick(() => {
            console.log('nextTick3')
            process.nextTick(() => {
                console.log('nextTick4')
            })
        })
    })
})
// nextTick1 nextTick2 nextTick3 nextTick4
//promise4 promise5 setTimeout1  promise1 setTimeout2 promise2  setImmediate1 promise3
```

